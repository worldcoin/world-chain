<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture - World Chain Specs</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">World Chain Specs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pbh-architecture"><a class="header" href="#pbh-architecture">PBH Architecture</a></h1>
<p>World Chain is an OP Stack chain that enables Priority Blockspace for Humans (PBH) through the World Chain Builder. World Chain leverages <a href="https://github.com/flashbots/rollup-boost">rollup-boost</a> to support external block production, allowing the builder to propose PBH blocks to the sequencer while remaining fully compatible with the OP Stack.</p>
<h2 id="block-production-on-the-op-stack"><a class="header" href="#block-production-on-the-op-stack">Block Production on the OP Stack</a></h2>
<p>The <a href="https://specs.optimism.io/protocol/exec-engine.html#engine-api">Engine API</a> defines the communication protocol between the Consensus Layer (CL) and the Execution Layer (EL) and is responsible for orchestrating block production on the OP Stack. Periodically, the sequencer's consensus client will send a fork choice update (FCU) to its execution client, signaling for a new block to be built. After a series of API calls between the CL and EL, the EL will return a new <code>ExecutionPayload</code> containing a newly constructed block. The CL will then advance the unsafe head of the chain and peer the new block to other nodes in the network.</p>
<pre class="mermaid">sequenceDiagram
    box OP Stack Sequencer
        participant sequencer-cl as Sequencer CL
        participant sequencer-el as Sequencer EL
    end
    box Network
        participant peers-cl as Peers
    end

    Note over sequencer-cl: FCU with Attributes
    sequencer-cl-&gt;&gt;sequencer-el: engine_forkChoiceUpdatedV3(ForkChoiceState, Attrs)
    sequencer-el--&gt;&gt;sequencer-cl: {payloadStatus: {status: VALID, ...}, payloadId: PayloadId}
    sequencer-el-&gt;&gt;sequencer-el: Build execution payload
    sequencer-cl-&gt;&gt;sequencer-el: engine_getPayloadV3(PayloadId)
    sequencer-el--&gt;&gt;sequencer-cl: {executionPayload, blockValue}
    sequencer-cl-&gt;&gt;peers-cl: Propagate new block


</pre>
<p>For a detailed look at how block production works on the OP Stack, see the <a href="https://specs.optimism.io/protocol/exec-engine.html#engine-api">OP Stack specs</a>.</p>
<h2 id="rollup-boost"><a class="header" href="#rollup-boost">Rollup Boost</a></h2>
<p><code>rollup-boost</code> is a block building sidecar for OP Stack chains, enabling external block production while remaining fully compatible with the OP Stack. <code>rollup-boost</code> acts as an intermediary between the sequencer's consensus and execution client. When <code>sequencer-cl</code> sends a new FCU to <code>rollup-boost</code>, the request will be multiplexed to both the sequencer's execution client and external block builders signaling that a new block should be built.</p>
<p>When the sequencer is ready to propose a new block, <code>op-node</code> will send an <code>engine_getPayload</code> request to <code>rollup-boost</code> which is forwarded to the default execution client and external block builders.</p>
<p>Once <code>rollup-boost</code> receives the built block from external builder, it will then validate the block by sending it to the sequencer's execution client via <code>engine_newPayload</code>. If the external block is valid, it is returned to the sequencer's <code>op-node</code>, otherwise <code>rollup-boost</code> will return the fallback block. Note that <code>rollup-boost</code> will always fallback to the default execution client's block in the case that the external builder does not respond in time or returns an invalid block.</p>
<pre class="mermaid">sequenceDiagram
    box Sequencer
        participant sequencer-cl as Sequencer CL
        participant rollup-boost
        participant sequencer-el as Sequencer EL
    end
    box Builder
        participant builder-el as Builder EL
    end

    Note over sequencer-cl: FCU with Attributes
    sequencer-cl-&gt;&gt;rollup-boost: engine_forkChoiceUpdatedV3(..., Attrs)

    Note over rollup-boost: Forward FCU
    rollup-boost-&gt;&gt;builder-el: engine_forkChoiceUpdatedV3(..., Attrs)

    rollup-boost-&gt;&gt;sequencer-el: engine_forkChoiceUpdatedV3(..., Attrs)
    sequencer-el--&gt;&gt;rollup-boost: {payloadId: PayloadId}
    rollup-boost--&gt;&gt;sequencer-cl: {payloadId: PayloadId}


    Note over sequencer-cl: Get Payload
    sequencer-cl-&gt;&gt;rollup-boost: engine_getPayloadV3(PayloadId)
    Note over rollup-boost: Forward Get Payload
    rollup-boost-&gt;&gt;sequencer-el: engine_getPayloadV3(PayloadId)
    rollup-boost-&gt;&gt;builder-el: engine_getPayloadV3(PayloadId)
    builder-el--&gt;&gt;rollup-boost: {executionPayload, blockValue}
    sequencer-el--&gt;&gt;rollup-boost: {executionPayload, blockValue}



    Note over rollup-boost, sequencer-el: Validate builder block
    rollup-boost-&gt;&gt;sequencer-el: engine_newPayloadV3(ExecutionPayload)
    sequencer-el-&gt;&gt;rollup-boost: {status: VALID, ...}

    Note over rollup-boost: Propose execution payload
    rollup-boost-&gt;&gt;sequencer-cl: {executionPayload, blockValue}
    
    Note over sequencer-cl: Propagate new block
</pre>
<p>In addition to Engine API requests, <code>rollup-boost</code> will proxy all RPC calls from the sequencer <code>op-node</code> to its local execution client. The following RPC calls will also be forwarded to external builders:</p>
<ul>
<li><code>miner_*</code>
<ul>
<li>The Miner API is used to notify execution clients of changes in effective gas price, extra data, and DA throttling requests from the batcher.</li>
</ul>
</li>
<li><code>eth_sendRawTransaction*</code>
<ul>
<li>Forwards transactions the sequencer receives to the builder for block building.</li>
</ul>
</li>
</ul>
 </br>
<h2 id="block-production-on-world-chain"><a class="header" href="#block-production-on-world-chain">Block Production on World Chain</a></h2>
<p>World Chain leverages <code>rollup-boost</code> to enable external block production and integrates the World Chain Builder as a block builder in the network. The World Chain Builder implements a custom block ordering policy (ie. PBH) to provide priority inclusion for transactions with a valid World ID proof. Note that the custom ordering policy adheres to the OP Stack spec.</p>
<p>Each block has a "PBH blockspace capacity", which determines how many PBH transactions will be included in the block. Blocks on World Chain will always reserve a percentage of blockspace for non-PBH transactions to ensure inclusion for automated systems and non-verified users. If there are not enough pending PBH transactions to fill the entirety of PBH blockspace, standard transactions will be used to fill the remainder of the block.</p>
<br>
<div style="display: flex; justify-content: center; gap: 40px;">
  <div style="border: 1px solid white; padding: 15px; width: 250px; text-align: center; color: white;">
    <div style="color: #bbbbbb; font-weight: bold; padding-bottom: 5px;">Default Block</div>
    <table style="width: 100%; margin-top: 10px;">
      <tr>
        <th style="width: 50%; border-bottom: 1px solid white;">Tx Hash</th>
        <th style="width: 50%; border-bottom: 1px solid white;">Fee</th>
      </tr>
      <tr><td>0xaaaa</td><td>$0.04</td></tr>
      <tr><td>0xbbbb</td><td>$0.04</td></tr>
      <tr><td>0xcccc</td><td>$0.03</td></tr>
      <tr><td>0xdddd</td><td>$0.03</td></tr>
      <tr><td>0xeeee</td><td>$0.03</td></tr>
      <tr><td>0x2222</td><td>$0.02</td></tr>
      <tr><td>0x3333</td><td>$0.02</td></tr>
      <tr><td>0x4444</td><td>$0.02</td></tr>
      <tr><td>0x5555</td><td>$0.01</td></tr>
      <tr><td>0x6666</td><td>$0.01</td></tr>
    </table>
  </div>
  <div style="border: 1px solid white; padding: 15px; width: 250px; text-align: center; color: white;">
    <div style="color: #bbbbbb; font-weight: bold; padding-bottom: 5px;">PBH Block</div>
    <table style="width: 100%; margin-top: 10px;">
      <tr>
        <th style="width: 50%; border-bottom: 1px solid white;">Tx Hash</th>
        <th style="width: 50%; border-bottom: 1px solid white;">Fee</th>
      </tr>
      <tr style="color: #33ff33;"><td>0x3333</td><td>$0.02</td></tr>
      <tr style="color: #33ff33;"><td>0x4444</td><td>$0.02</td></tr>
      <tr style="color: #33ff33;"><td>0x5555</td><td>$0.01</td></tr>
      <tr style="color: #33ff33;"><td>0x6666</td><td>$0.01</td></tr>
      <tr><td>0xaaaa</td><td>$0.04</td></tr>
      <tr><td>0xbbbb</td><td>$0.04</td></tr>
      <tr><td>0xcccc</td><td>$0.03</td></tr>
      <tr><td>0xdddd</td><td>$0.03</td></tr>
      <tr><td>0xeeee</td><td>$0.03</td></tr>
      <tr><td>0x2222</td><td>$0.02</td></tr>
    </table>
  </div>
</div>
<br>
<p>If the amount of pending PBH transactions exceed the PBH blockspace capacity, the remaining PBH transactions will carry over to the next block. PBH transactions aim to provide verified users with faster, cheaper transaction inclusion, especially during network congestion. Note that transactions within PBH blockspace are ordered by priority fee.</p>
<p>In the event that the block builder is offline, <code>rollup-boost</code> will fallback to the block built by the default execution client with standard OP Stack ordering rules.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pbh/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pbh/txs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pbh/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pbh/txs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>
        <script src="../specs/static/solidity-min.js"></script>



    </div>
    </body>
</html>
